<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpikeInterface GUI Iframe Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .iframe-container {
            width: 100%;
            height: 800px;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .data-display {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow: auto;
        }
        h1, h2 {
            color: #333;
        }
        pre {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            overflow: auto;
            margin: 0;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .send-controls {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 20px;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .button-secondary {
            background-color: #2196F3;
        }
        .button-secondary:hover {
            background-color: #0b7dda;
        }
        .button-danger {
            background-color: #f44336;
        }
        .button-danger:hover {
            background-color: #da190b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SpikeInterface GUI Iframe Test - Bidirectional Communication</h1>

        <div class="controls">
            <button id="startServerBtn">Start Test Server</button>
            <button id="clearBtn">Clear Received Data</button>
            <label>
                <input type="checkbox" id="autoSendCheckbox"> Auto send when ready
            </label>
        </div>

        <div class="iframe-container">
            <iframe id="guiFrame" src="about:blank"></iframe>
        </div>

        <h2>Send Curation Data to iframe:</h2>
        <div class="send-controls">
            <p>Edit the curation data below and click "Send to iframe" to update the GUI:</p>
            <textarea id="curationInput">{}</textarea>
            <div class="controls" style="margin-top: 10px;">
                <button id="sendDataBtn" class="button-secondary">Send to iframe</button>
                <button id="resetDataBtn" class="button-secondary">Reset to Default</button>
                <button id="clearCurationBtn" class="button-danger">Clear All Curation</button>
            </div>
        </div>
        
        <h2>Received Data from iframe:</h2>
        <div class="data-display">
            <pre id="dataOutput">No data received yet...</pre>
        </div>
    </div>

    <script>
        // DOM elements
        const iframe = document.getElementById('guiFrame');
        const dataOutput = document.getElementById('dataOutput');
        const curationInput = document.getElementById('curationInput');
        const clearBtn = document.getElementById('clearBtn');
        const startServerBtn = document.getElementById('startServerBtn');
        const sendDataBtn = document.getElementById('sendDataBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');
        const clearCurationBtn = document.getElementById('clearCurationBtn');
        const autoSendCheckbox = document.getElementById('autoSendCheckbox');

        // Store received data
        let receivedData = [];
        let autoSendEnabled = false;
        let defaultCurationData = null;

        // Update auto-send state when checkbox changes
        autoSendCheckbox.addEventListener('change', function() {
            autoSendEnabled = autoSendCheckbox.checked;
            console.log('Auto-send ' + (autoSendEnabled ? 'enabled' : 'disabled'));
        });

        // Load default curation data from curation.json
        fetch('/curation.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                defaultCurationData = data;
                // Initialize the textarea with the loaded data
                curationInput.value = JSON.stringify(defaultCurationData, null, 2);
                console.log('Loaded curation data from curation.json');
            })
            .catch(error => {
                console.error('Error loading curation.json:', error);
                // Fallback to simple default data
                defaultCurationData = {
                    "merges": [
                        {"unit_ids": ["1", "2"]},
                        {"unit_ids": ["5", "6", "7"]}
                    ],
                    "removed": ["3", "8"],
                    "splits": [
                        {
                            "unit_id": "4",
                            "mode": "indices",
                            "indices": [[0, 1, 2, 3, 4]]
                        }
                    ]
                };
                curationInput.value = JSON.stringify(defaultCurationData, null, 2);
                console.log('Using fallback curation data');
            });

        // Event listener for messages from the iframe
        function handleMessage(event) {
            console.log('Message received from iframe:', event.data);

            // Ignore messages from browser extensions
            if (event.data && event.data.source === 'react-devtools-content-script') {
                return;
            }

            // Check if the message is from our Panel application
            if (event.data && event.data.type === 'panel-data') {
                const data = event.data.data;
                receivedData.push(data);
                
                // Format and display the data
                displayReceivedData();

                // Check for loaded status and auto-send if enabled
                if (data && data.loaded === true) {
                    console.log('iframe loaded detected, auto-send enabled:', autoSendCheckbox.checked);
                    if (autoSendCheckbox.checked) {
                        console.log('Auto-sending curation data...');
                        const curationData = curationInput.value;
                        setTimeout(() => {
                            sendCurationData(curationData);
                        }, 100); // Small delay to ensure iframe is fully ready
                    }
                }
            }
        }
        
        // Add the event listener
        window.addEventListener('message', handleMessage);
        
        // Function to display the received data
        function displayReceivedData() {
            if (receivedData.length === 0) {
                dataOutput.textContent = 'No data received yet...';
                return;
            }
            
            // Format the data as JSON
            const formattedData = receivedData.map((data, index) => {
                return `--- Data ${index + 1} ---\n${JSON.stringify(data, null, 2)}`;
            }).join('\n\n');
            
            dataOutput.textContent = formattedData;
            
            // Scroll to the bottom of the data display
            dataOutput.scrollTop = dataOutput.scrollHeight;
        }
        
        // Function to send curation data to the iframe
        function sendCurationData(curationData) {
            try {
                // Validate the JSON
                const data = typeof curationData === 'string' 
                    ? JSON.parse(curationData) 
                    : curationData;
                
                console.log('Sending curation data to iframe:', data);
                
                // Send the message to the iframe
                iframe.contentWindow.postMessage({
                    type: 'curation-data',
                    data: data
                }, '*');
                
                console.log('Curation data sent to iframe successfully!');
            } catch (error) {
                console.error('Error sending curation data:', error);
                alert('Error sending curation data: ' + error.message);
            }
        }
        
        // Clear button event listener
        clearBtn.addEventListener('click', function() {
            receivedData = [];
            displayReceivedData();
            
            // Re-add the event listener to ensure it's working
            window.removeEventListener('message', handleMessage);
            window.addEventListener('message', handleMessage);
            console.log('Event listener reset');
        });
        
        // Send data button event listener
        sendDataBtn.addEventListener('click', function() {
            const curationData = curationInput.value;
            sendCurationData(curationData);
        });
        
        // Reset data button event listener
        resetDataBtn.addEventListener('click', function() {
            if (defaultCurationData) {
                curationInput.value = JSON.stringify(defaultCurationData, null, 2);
            }
        });
        
        // Clear curation button event listener
        clearCurationBtn.addEventListener('click', function() {
            const emptyCuration = {
                "merges": [],
                "removed": [],
                "splits": []
            };
            sendCurationData(emptyCuration);
        });
        
        // Start server button event listener
        startServerBtn.addEventListener('click', function() {
            // Disable the button while starting the server
            startServerBtn.disabled = true;
            startServerBtn.textContent = 'Starting server...';
            
            // Execute the test_mainwindow.py script to start the server
            fetch('/start_test_server')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Load the server URL in the iframe
                        iframe.src = data.url;
                        startServerBtn.textContent = 'Server Running';
                    } else {
                        alert('Failed to start test server: ' + data.error);
                        startServerBtn.disabled = false;
                        startServerBtn.textContent = 'Start Test Server';
                    }
                })
                .catch(error => {
                    console.error('Error starting test server:', error);
                    alert('Error starting test server. See console for details.');
                    startServerBtn.disabled = false;
                    startServerBtn.textContent = 'Start Test Server';
                });
        });
        
        // For testing purposes, you can manually set the iframe URL
        // This is useful if you're running the server separately
        function setIframeUrl(url) {
            iframe.src = url;
        }
        
        // Add instructions for using the curation view
        dataOutput.textContent = `Instructions:
1. Click "Start Test Server" to launch the SpikeInterface GUI
2. Optionally enable "Auto send when ready" to automatically send curation data when the iframe signals it's loaded
3. Once loaded, navigate to the "curation" tab

Testing SEND (parent → iframe):
- Edit the curation data in the textarea above
- Click "Send to iframe" to update the GUI's curation data
- The GUI should refresh and show the new curation data

Testing RECEIVE (iframe → parent):
- Click the "Submit to parent" button in the GUI's curation view
- The received data will appear in this section below

Note: The first time you start the server, it may take a minute to generate test data.`;
    </script>
</body>
</html>
